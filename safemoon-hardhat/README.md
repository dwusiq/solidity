# safemoon调研报告

# 总览
* safemoon包含两个相互独立的池（对内、对外）


## 关注点
* 每笔交易扣一定比例的[流动性手续费]给当前合约,当这笔费用总额到达指定阈值时，直接取一半余额从`uniswap`赎回`safemoon`,再将[`safemoon`-`ETH`]交易对流动性追加到`unisawp`
* 每笔交易扣一定比例的[交易费],扣费后`_tFeeTotal`值累加,`_rTotal`则相应减少
* 转账时，黑名单用户同时修改对内对外份额。白名单用户只修改对内份额
* 分红原理：核心函数是`_reflectFee`、`tokenFromReflection`。每笔交易都扣分红费，对外部分只记录分红总额而不扣减总额，但对内则直接扣减当前总额。导致（内部总额/外部总额）的值变小，接使分红用户的余额增加【外部金额=内部金额/内外总额比值】


## 关键属性介绍
* `_tTotal`：对外展示的币总量，为1000000000 * 10**6 * 10**9，可以看出是总的蛋糕
* `_rTotal`: 是内部实际的币总量（是_tTotal的N倍），为2^256-(2^256%_tTotal)，是一个很大的数，可以看出是盘子的数量【个人推算这套公式的目的是为了取值_tTotal的整倍数，而且是solidity能支持的最大值】
* `_tFeeTotal`: 收取的手续费，可以看成是打碎了多少盘子，但是不影响总蛋糕_tTotal


## 转账相关细节

* 发送者在黑名单，接收者不在黑名单【发送者同时减少对内和对外展示的份额，接收者只增加对内份额】
* 发送者不在黑名单，接收者在黑名单【发送者只减少对内份额，接收者同时增加对内对外的份额】
* 发送者和接收者都不在黑名单【发送者只减少对内份额，接收者只新增对内份额】
* 发送者和接收者都在黑名单【发送者同时减少对内对外份额，接收者同时增加对内对外的份额】
* 其它情况正常发交易【发送者只减少对内份额，接收者只新增对内份额】
        
**总结：转账时，不管是发送者还是接收者，黑名单用户同时修改对内对外份额，白名单用户只修改对内份额**

## 简单案例解析实现原理
* 简单案例
  - 外总100：内总1000，用户持有50外 ，按比例相当于持有500内
  - 此时分红10外。按比例相当于分红100内，实际操作内总减100。操作后此时外总100:内总900
  - 因此个人当前持有外=个人500内 /(内总100/外总900) =（约）55.5555
* 案例验证：
  - 个人50：总100
  - 分红10，则除了分红部分后，个人50：总90
  - 10分红中，个人能领到=10*(50/90)=5.555555...555
  - 因此分红后个人余额=50+5.555555...555=55.555555.5555
  
**思考1：那为什么不直接用单池呢？因为:1、如果不使用分红池，则需要每次转账都结算一次所有用户的余额，人数越多耗gas余额大。 2、如果使用分红池，则每次转账都涉及到所有人的比例变动，包括分红池，并且转账发起者本身也在分红吃占有一定比例，这样个人余额及分红池的进进出出很难缕清楚，至少我没想到**
**思考2：每次都通过内部总额的减少来间接实现外部分红，虽然内部总值很大，但终归有减到内部总额减当次交易手续费少于外部总额时，按比例计算，所有用户的余额都会变少。当然也可以限制到一定程度就不扣手续费来规避这点了**


## 参考
* [通缩分红币Safemoon解读](https://blog.csdn.net/biakia0610/article/details/119252509)